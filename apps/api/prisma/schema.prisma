generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(uuid()) @db.Uuid
  email           String           @unique @db.VarChar(255)
  emailVerified   Boolean          @default(false) @map("email_verified")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  lastLogin       DateTime?        @map("last_login")
  profileData     Json             @default("{}") @map("profile_data")
  auth0Id         String?          @unique @map("auth0_id") @db.VarChar(255)
  name            String?          @db.VarChar(255)
  picture         String?          @db.VarChar(2048)
  answers         QuizAnswer[]     @relation("UserAnswers")
  roomMemberships QuizRoomMember[] @relation("UserRoomMemberships")
  hostedRooms     QuizRoom[]       @relation("HostUserRooms")
  quizzes         Quiz[]
  threads         Thread[]

  @@map("users")
}

model Tag {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar(100)
  slug        String    @db.VarChar(100)
  isPrimary   Boolean   @default(false) @map("is_primary")
  icon        String?   @db.VarChar(50)
  color       String?   @db.VarChar(50)
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  quizzes     QuizTag[]

  @@unique([name, isPrimary])
  @@unique([slug, isPrimary])
  @@map("tags")
}

model Quiz {
  id             String        @id @default(uuid()) @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  title          String        @db.VarChar(255)
  description    String?
  difficulty     String        @default("medium") @db.VarChar(50)
  timeLimit      Int           @default(1800) @map("time_limit")
  totalQuestions Int           @map("total_questions")
  quizData       Json          @map("quiz_data")
  status         String        @default("draft") @db.VarChar(50)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  publishedAt    DateTime?     @map("published_at")
  version        Int           @default(1)
  imageUrl       String?       @map("image_url") @db.VarChar(2048)
  rooms          QuizRoom[]    @relation("QuizToRooms")
  tags           QuizTag[]
  versions       QuizVersion[]
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  threads        Thread[]

  @@map("quizzes")
}

model QuizTag {
  quizId    String   @map("quiz_id") @db.Uuid
  tagId     String   @map("tag_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([quizId, tagId])
  @@map("quiz_tags")
}

model QuizVersion {
  id            String   @id @default(uuid()) @db.Uuid
  quizId        String   @map("quiz_id") @db.Uuid
  version       Int
  quizData      Json     @map("quiz_data")
  changeSummary String?  @map("change_summary")
  createdAt     DateTime @default(now()) @map("created_at")
  createdBy     String   @map("created_by") @db.Uuid
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("quiz_versions")
}

model Thread {
  id            String          @id @default(uuid()) @db.Uuid
  userId        String          @map("user_id") @db.Uuid
  redisThreadId String?         @map("redis_thread_id") @db.VarChar(100)
  title         String?         @db.VarChar(255)
  status        String          @default("active") @db.VarChar(50)
  quizId        String?         @map("quiz_id") @db.Uuid
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  expiresAt     DateTime?       @map("expires_at")
  contextData   Json            @default("{}") @map("context_data")
  messages      ThreadMessage[]
  quiz          Quiz?           @relation(fields: [quizId], references: [id])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("threads")
}

model ThreadMessage {
  id             String   @id @default(uuid()) @db.Uuid
  threadId       String   @map("thread_id") @db.Uuid
  role           String   @db.VarChar(50)
  content        String
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  sequenceNumber Int      @map("sequence_number")
  thread         Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@map("thread_messages")
}

model QuizRoom {
  id         String           @id @default(uuid()) @db.Uuid
  pin        String           @unique @db.Char(6)
  hostUserId String           @map("host_user_id") @db.Uuid
  quizId     String           @map("quiz_id") @db.Uuid
  status     String           @default("lobby") @db.VarChar(50)
  settings   Json             @default("{}") @map("settings_json")
  createdAt  DateTime         @default(now()) @map("created_at")
  startedAt  DateTime?        @map("started_at")
  endedAt    DateTime?        @map("ended_at")
  closedAt   DateTime?        @map("closed_at")
  answers    QuizAnswer[]     @relation("RoomAnswers")
  members    QuizRoomMember[] @relation("RoomMembers")
  hostUser   User             @relation("HostUserRooms", fields: [hostUserId], references: [id], onDelete: Cascade)
  quiz       Quiz             @relation("QuizToRooms", fields: [quizId], references: [id])

  @@map("quiz_rooms")
}

model QuizRoomMember {
  id          String    @id @default(uuid()) @db.Uuid
  roomId      String    @map("room_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  displayName String    @map("display_name") @db.VarChar(100)
  role        String    @default("player") @db.VarChar(20)
  joinedAt    DateTime  @default(now()) @map("joined_at")
  leftAt      DateTime? @map("left_at")
  kickedBy    String?   @map("kicked_by") @db.Uuid
  kickReason  String?   @map("kick_reason")
  picture     String?   @map("picture") @db.VarChar(2048)
  room        QuizRoom  @relation("RoomMembers", fields: [roomId], references: [id], onDelete: Cascade)
  user        User      @relation("UserRoomMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@map("quiz_room_members")
}

model QuizAnswer {
  id            String   @id @default(uuid()) @db.Uuid
  roomId        String   @map("room_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  questionIndex Int      @map("question_index")
  answer        String
  answerTimeMs  BigInt   @map("answer_time_ms")
  scoreDelta    Int      @default(0) @map("score_delta")
  createdAt     DateTime @default(now()) @map("created_at")
  isCorrect     Boolean  @default(false) @map("is_correct")
  room          QuizRoom @relation("RoomAnswers", fields: [roomId], references: [id], onDelete: Cascade)
  user          User     @relation("UserAnswers", fields: [userId], references: [id], onDelete: Cascade)

  @@index([roomId, questionIndex])
  @@index([roomId, userId])
  @@map("quiz_answers")
}

model QuizGameSession {
  id             String   @id @default(uuid()) @db.Uuid
  roomId         String   @unique @map("room_id") @db.Uuid
  quizId         String   @map("quiz_id") @db.Uuid
  hostId         String   @map("host_id") @db.Uuid
  startedAt      DateTime @map("started_at")
  endedAt        DateTime @map("ended_at")
  durationMs     BigInt   @map("duration_ms")
  totalQuestions Int      @map("total_questions")
  totalPlayers   Int      @map("total_players")
  completionRate Float    @default(0) @map("completion_rate")
  averageScore   Float    @default(0) @map("average_score")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([quizId])
  @@index([hostId])
  @@map("quiz_game_sessions")
}
