# ADR 004: Infrastructure as Code Approach

## Status

Accepted

## Context

The Quiz Maker project requires infrastructure for:

- Docker containerization
- Database configurations
- Development environment setup
- Production deployment configurations

Previously, infrastructure configurations were scattered across different directories:

- `docker/` - Docker files
- `database/` - Database configurations
- Various `.env` files in different modules

This led to:

- Inconsistent environment configurations
- Difficult development environment setup
- Hard-to-reproduce deployments
- Version control issues for infrastructure

## Decision

Consolidate all infrastructure-related configurations into a dedicated `infra/` directory following Infrastructure as Code principles:

- `infra/docker/` - All Docker configurations
- `infra/database/` - Database schemas and migrations
- `infra/README.md` - Infrastructure documentation
- Version controlled infrastructure configurations

## Consequences

### Positive

- **Centralized Configuration**: Single location for all infrastructure code
- **Version Control**: Infrastructure changes are tracked and auditable
- **Reproducibility**: Development environments can be consistently reproduced
- **Documentation**: Centralized infrastructure documentation
- **Team Collaboration**: Clear ownership of infrastructure concerns
- **Environment Parity**: Development and production environments are similar

### Negative

- **Centralization**: Single point of failure for infrastructure changes
- **Learning Curve**: Team members need to understand infrastructure organization
- **Tooling Requirements**: Requires Docker and related tools

### Mitigation

- Comprehensive documentation in `infra/README.md`
- Clear examples and patterns
- Automated setup scripts
- Environment-specific configurations

## Implementation

### Directory Structure

```
infra/
├── docker/                    # Docker configurations
│   ├── Dockerfile.api # API image
│   ├── Dockerfile.quiz-generator # Quiz generator image
│   ├── Dockerfile.socket # WebSocket service image
│   └── docker-compose.yml     # Development environment
├── database/                  # Database configurations
│   ├── migrations/            # Database migrations
│   └── mongodb/               # MongoDB configurations
└── README.md                  # Infrastructure documentation
```

### Docker Configuration

#### Development Environment

```yaml
# docker-compose.yml
version: "3.8"
services:
  api:
    build:
      context: ../apps/api
      dockerfile: ../infra/Dockerfile.api
    # ... configuration
```

#### Production Images

```dockerfile
# Dockerfile.api
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

### Database Configuration

#### Prisma Schema

- All database schemas defined in `apps/api/prisma/schema.prisma`
- Migrations generated by Prisma only
- Database as single source of truth

#### Migration Management

```bash
# Generate migrations
cd apps/api
npx prisma migrate dev --name migration_name

# Apply migrations
npx prisma migrate deploy
```

### Environment Configuration

#### Development

```bash
# Start development environment
docker-compose up -d

# View logs
docker-compose logs -f

# Stop services
docker-compose down
```

#### Production

```bash
# Build production images
docker build -f infra/Dockerfile.api -t quiz-maker/api:latest .
docker build -f infra/Dockerfile.quiz-generator -t quiz-maker/quiz-gen:latest .
docker build -f infra/Dockerfile.socket -t quiz-maker/socket:latest .
```

## Development Workflow

1. **Infrastructure Changes**:
   - Make changes in `infra/` directory
   - Test with `docker-compose up`
   - Commit infrastructure changes
   - Update documentation if needed

2. **Database Changes**:
   - Update Prisma schema in `apps/api/prisma/`
   - Generate migrations
   - Test migrations locally
   - Commit schema and migration files

3. **Environment Setup**:
   - Clone repository
   - Copy environment templates
   - Run `docker-compose up -d`
   - Follow setup instructions in `infra/README.md`

## Security Considerations

- **Environment Variables**: Sensitive data stored in `.env` files (not committed)
- **Network Isolation**: Services communicate through defined Docker networks
- **Volume Mounts**: Data persistence with proper permissions
- **Health Checks**: Service health monitoring and restart policies

## Related Decisions

- ADR 001: Project Restructuring to Modular Architecture
- ADR 005: Development workflow standardization
- ADR 006: Database schema management with Prisma
