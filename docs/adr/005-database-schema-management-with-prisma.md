# ADR 005: Database Schema Management with Prisma

## Status

Accepted

## Context

The Quiz Maker project requires a robust database solution for:

- User management and authentication
- Quiz content storage
- Real-time session data
- User progress tracking
- Analytics and reporting

We needed to choose between:

- Manual SQL schema management
- ORM with manual migrations
- Prisma with automatic migration generation
- NoSQL solutions (MongoDB)

## Decision

Use **Prisma** as the standard source of truth for database schema management with the following principles:

- **Single Source of Truth**: All database schemas defined in `apps/api/prisma/schema.prisma`
- **Prisma-Generated Migrations Only**: All migrations must be generated by Prisma
- **Type Safety**: Full TypeScript integration with generated types
- **Migration History**: Version-controlled migration files
- **Database Agnostic**: Support for multiple database providers

## Consequences

### Positive

- **Type Safety**: Full TypeScript integration with generated types
- **Automatic Migrations**: Prisma generates and manages migration files
- **Schema Validation**: Built-in schema validation and error checking
- **Database Agnostic**: Easy to switch between database providers
- **Developer Experience**: Excellent tooling and documentation
- **Migration History**: Clear audit trail of database changes
- **Consistency**: Ensures schema and code are always in sync

### Negative

- **Learning Curve**: Team needs to learn Prisma concepts
- **Vendor Lock-in**: Tied to Prisma ecosystem
- **Migration Complexity**: Complex migrations may require manual intervention
- **Performance**: Additional abstraction layer

### Mitigation

- Comprehensive Prisma documentation and training
- Clear migration guidelines and best practices
- Performance monitoring and optimization
- Regular schema reviews and optimization

## Implementation

### Schema Definition

```prisma
// apps/api/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  auth0Id      String   @unique
  email        String   @unique
  name         String?
  picture      String?
  emailVerified Boolean @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastLogin    DateTime?

  // Relations
  quizzes      Quiz[]
  rooms        RoomMember[]

  @@map("users")
}

model Quiz {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  userId      String   @db.ObjectId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id])
  questions   Question[]
  rooms       Room[]

  @@map("quizzes")
}
```

### Migration Management

#### Generate Migrations

```bash
# Development
cd apps/api
npx prisma migrate dev --name descriptive_migration_name

# Production
npx prisma migrate deploy
```

#### Migration Files

```sql
-- apps/api/prisma/migrations/YYYYMMDDHHMMSS_migration_name/migration.sql
-- CreateTable
CREATE TABLE "users" (
    "_id" TEXT NOT NULL,
    "auth0Id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "name" TEXT,
    "picture" TEXT,
    "emailVerified" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "lastLogin" DATETIME,

    CONSTRAINT "users_pkey" PRIMARY KEY ("_id")
);

-- CreateIndex
CREATE UNIQUE INDEX "users_auth0Id_key" ON "users"("auth0Id");
CREATE UNIQUE INDEX "users_email_key" ON "users"("email");
```

### Type Generation

```typescript
// Generated types in apps/api/node_modules/.prisma/client/index.d.ts
export type User = {
  id: string;
  auth0Id: string;
  email: string;
  name: string | null;
  picture: string | null;
  emailVerified: boolean;
  createdAt: Date;
  updatedAt: Date;
  lastLogin: Date | null;
};

export type Quiz = {
  id: string;
  title: string;
  description: string | null;
  userId: string;
  createdAt: Date;
  updatedAt: Date;
};
```

### Usage in Code

```typescript
// apps/api/src/modules/quiz/quiz.service.ts
import { PrismaClient, type Quiz, type User } from "@prisma/client";

export class QuizService {
  private prisma = new PrismaClient();

  async createQuiz(data: CreateQuizDTO, userId: string): Promise<Quiz> {
    return await this.prisma.quiz.create({
      data: {
        title: data.title,
        description: data.description,
        userId: userId,
      },
      include: {
        user: true,
        questions: true,
      },
    });
  }

  async getUserQuizzes(userId: string): Promise<Quiz[]> {
    return await this.prisma.quiz.findMany({
      where: { userId },
      include: {
        questions: true,
        rooms: true,
      },
    });
  }
}
```

## Migration Guidelines

### 1. **Schema Changes**

- Always modify `schema.prisma` first
- Use descriptive migration names
- Test migrations locally before committing
- Review generated SQL for correctness

### 2. **Breaking Changes**

- Use `@map()` for table/column renaming
- Implement data migration scripts if needed
- Coordinate with frontend changes
- Document breaking changes clearly

### 3. **Data Migration**

```typescript
// Custom migration scripts if needed
export async function migrateUserData() {
  const prisma = new PrismaClient();

  try {
    // Custom migration logic
    await prisma.$executeRaw`UPDATE users SET emailVerified = true WHERE email IS NOT NULL`;
  } finally {
    await prisma.$disconnect();
  }
}
```

## Environment Configuration

### Development

```bash
# .env
MONGODB_URI="mongodb://localhost:27017/quiz_ai_system"
```

### Production

```bash
# .env
MONGODB_URI="mongodb+srv://username:password@cluster.mongodb.net/quiz_ai_system"
```

## Testing

### Unit Tests

```typescript
// Mock Prisma client for testing
import { PrismaClient } from "@prisma/client";

jest.mock("@prisma/client", () => ({
  PrismaClient: jest.fn().mockImplementation(() => ({
    quiz: {
      create: jest.fn(),
      findMany: jest.fn(),
    },
  })),
}));
```

### Integration Tests

```typescript
// Use test database
const testPrisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.TEST_MONGODB_URI,
    },
  },
});
```

## Related Decisions

- ADR 004: Infrastructure as Code Approach
- ADR 006: Authentication and Authorization Strategy
- ADR 007: Data Validation and Sanitization
